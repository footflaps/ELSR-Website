{% extends "base.html" %}


{% block content %}


<!---------------------------------------------------------------------------------------------------->
<!--                                     Page Header                                                -->
<!---------------------------------------------------------------------------------------------------->

<header class="masthead" style="background-image: url({{ url_for('static', filename='img/admin-bg.jpg')}})">
	<div class="overlay"></div>
	<div class="container">
		<div class="row">
			<div class="col-lg-8 col-md-10 mx-auto">
				<div class="page-heading">
					<h1>Admin Console</h1>
					<span class="subheading">The power of God!</span>
				</div>
			</div>
		</div>
	</div>
</header>


<!---------------------------------------------------------------------------------------------------->
<!--                                 Show flash messages                                            -->
<!---------------------------------------------------------------------------------------------------->

{% with messages = get_flashed_messages() %}
{% if messages %}
{% for message in messages %}
<div class="alert alert-warning text-center">
	{{ message }}
</div>
{% endfor %}
{% endif %}
{% endwith %}


<!---------------------------------------------------------------------------------------------------->
<!--                                        Messages                                                -->
<!---------------------------------------------------------------------------------------------------->

{% if messages %}

<a name="messages" ></a>
<div class="container">
	<div class="row">
		<div class="col-10 mx-auto">
			
			<h2>Admin Messages</h2>
			
			<div class="accordion" id="accordionExample">
				
				{% for message in messages %}
				
					<!------------------------------------------------------>
					<!--                   One Message                    -->
					<!------------------------------------------------------>
					<div class="card">
						
						<!-- Header -->
						<div class="card-header" id="heading{{loop.index}}">
							<h5 class="mb-0">
								<!-- Show different icon / button if read / unread -->
								{% if message.been_read() %}
									<button class="btn-sm btn-secondary mr-2" type="button" data-toggle="collapse" data-target="#collapse{{loop.index}}"
								            aria-expanded="true" aria-controls="collapse{{loop.index}}">
										<i class="fa-regular fa-envelope-open fa-xl"></i>
										Message {{loop.index}}
									</button>
								{% else %}
									<button class="btn-sm btn-primary mr-2" type="button" data-toggle="collapse" data-target="#collapse{{loop.index}}"
								            aria-expanded="true" aria-controls="collapse{{loop.index}}">
										<i class="fa-regular fa-envelope fa-xl"></i>
										Message {{loop.index}}
									</button>
								{% endif %}
							</h5>
						</div>
						
						<!-- Body -->
						<div id="collapse{{loop.index}}" class="collapse" aria-labelledby="heading{{loop.index}}"
						     data-parent="#accordionExample">
							<div class="card-body">
								<strong>From: {{ message.from_name }}</strong><br>
								<strong>Date: {{ message.sent_date }}</strong><br>
								{{ message.body }}
								
								<hr>
								
								<!-- Reply Button -->
								<a data-toggle="modal" data-target="#replyMessageModal{{message.id}}">
									<button class="btn-sm btn-primary mr-2" type="button">Reply</button>
								</a>
								
								<!-- Mark read / unread buttons -->
								{% if message.been_read() %}
									<a href="{{ url_for('mark_unread', message_id=message.id, return_to=url_for('admin_page', _anchor='messages')) }}">
										<button class="btn-sm btn-secondary mr-2" type="button">Mark as unRead</button>
									</a>
								{% else %}
									<a href="{{ url_for('mark_read', message_id=message.id, return_to=url_for('admin_page', _anchor='messages')) }}">
										<button class="btn-sm btn-secondary mr-2" type="button">Mark as Read</button>
									</a>
								{% endif %}
								
								<!-- Delete Button -->
								<a href="{{ url_for('delete_message', message_id=message.id, return_to=url_for('admin_page', _anchor='messages')) }}">
									<button class="btn-sm btn-danger float-right" type="button">Delete</button>
								</a>
								
							</div>
						</div>
					
					</div>

					<!------------------------------------------------------>
					<!--                 End of One Message               -->
					<!------------------------------------------------------>
				
					<!---------------------------------------------------------------------------------------------------->
					<!--                              Modal form for Reply to Message                                   -->
					<!---------------------------------------------------------------------------------------------------->
					
					<div class="modal fade" id="replyMessageModal{{message.id}}" tabindex="-1" role="dialog"
					     aria-labelledby="exampleModalLabel" aria-hidden="true">
						<div class="modal-dialog" role="document">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title" id="replyMessageLabel{{message.id}}">Can't let someone else have the last word?</h5>
									
									<button type="button" class="close" data-dismiss="modal" aria-label="Close">
										<span aria-hidden="true">&times;</span>
									</button>
								</div>
								<div class="modal-body">
									<!--
										NB To get the two parameters use:
											1. gpx_id = request.args.get('gpx_id', None)
					                        2. confirm = request.form['confirm']
									-->
									<form action="{{ url_for('reply_message', message_id=message.id) }}" method="GET">
										
										<div class="form-group">
											<label for="body" class="col-form-label">
												If you really must, enter your message here:
											</label>
											<textarea class="form-control" name="body" id="body" rows="6"></textarea>
										</div>
										
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
											<button type="submit" class="btn btn-primary">MUST HAVE LAST WORD</button>
										</div>
										
									</form>
								</div>
							</div>
						</div>
					</div>  <!-- End of modal form -->
				
				{% endfor %}
				
			</div>
			
			<!-- Break before next section -->
			<hr>
			
		</div>
	</div>
</div>

{% endif %}


<!---------------------------------------------------------------------------------------------------->
<!--                                      User Tables                                               -->
<!---------------------------------------------------------------------------------------------------->

<div class="container">
	<div class="row">
		<div class="col-lg-8 col-md-10 mx-auto">
			
			<!---------------------------------------------------------------------------------------->
			<!--                               Admins                                               -->
			<!---------------------------------------------------------------------------------------->
			
			<h2>Current Admins</h2>
			<table class="table table-bordered table-striped table-sm table-condensed">
				
				<!-- Header -->
				<thead>
					<tr>
						<th scope="col">ID</th>
						<th scope="col">Name</th>
						<th scope="col">Permissions</th>
						{% if not mobile %}
							<th scope="col">Start date</th>
						{% endif %}
						<th scope="col">Last Login</th>
					</tr>
				</thead>
				
				<tbody>
					{% for user in users: %}
						{% if user.admin() %}
						<tr>
							<th scope="row">{{user.id}}</th>
							<td><a href="{{ url_for('user_page', user_id=user.id) }}">{{user.name}}</a></td>
							<td>{{user.permissions}}</td>
							{% if not mobile %}
								<td>{{user.start_date}}</td>
							{% endif %}
							<td>{{user.last_login}}  ({{user.last_login_ip}})</td>
						</tr>
						
						{% endif %}
					{% endfor %}
				</tbody>
			
			</table>
			
			<!-- Seperator before next section -->
			<hr>
			
		</div>
	</div>
</div>

	
<!---------------------------------------------------------------------------------------->
<!--                                Users                                               -->
<!---------------------------------------------------------------------------------------->

<div class="container">
	
	<div class="row">
		<div class="col-lg-8 col-md-10 mx-auto">
			
			<h2 class="post-title float-left">Current Users</h2>
			
			<!-- Button to expose hidden table -->
			<a class="btn btn-primary float-right"  data-toggle="collapse" href="#collapseCafeList"
			   role="button" aria-expanded="false" aria-controls="collapseExample">
	            SHOW
	        </a>
			
		</div>
	</div>

	<!-- Collapsed / Hidden table of cafes -->
	<div class="collapse" id="collapseCafeList">
		<div class="row">
			<div class="col-lg-8 col-md-10 mx-auto">
				
				{% if mobile %}
					<table id="userTable" class="table table-striped table-bordered table-sm table-condensed">
				{% else %}
					<table id="userTable" class="table table-striped table-bordered table-sm table-condensed" style="width: 730px">
				{% endif %}
				
				
					<!-- Header -->
					<thead>
						<tr>
							<th scope="col">ID</th>
							<th scope="col">Name</th>
							<th scope="col">Permissions</th>
							<th scope="col">Start date</th>
							<th scope="col">Last Login</th>
						</tr>
					</thead>
					
					<tbody>
						{% for user in users: %}
							{% if not user.admin() %}
							
								<!--
									Colour code according to status
									Yellow      Not verified
									Read        Barred
								-->
								{% if user.blocked() %}
									<tr class="table-danger">
								{% elif not user.verified() %}
									<tr class="table-warning">
								{% else %}
									<tr>
								{% endif %}
								
								<td scope="row">{{user.id}}</td>
								<td><a href="{{ url_for('user_page', user_id=user.id) }}">{{user.name}}</a></td>
								<td>{{user.permissions}}</td>
								<td>{{user.start_date}}</td>
								<td>{{user.last_login}} ({{user.last_login_ip}})</td>
							</tr>
							
							{% endif %}
						{% endfor %}
					</tbody>
				
				</table>
			
				<p>Note: <br>
				   -- Users in Red have had their email address blocked. <br>
				   -- Users in yellow haven't verified their email addresses yet.</p>
						
			</div>
			
		</div>
	</div>
	
	<!-- Separator before next section -->
	<div class="row mb-3">
		<div class="col-lg-8 col-md-10 mx-auto">
			<hr>
		</div>
	</div>
	
</div>


<!---------------------------------------------------------------------------------------------------->
<!--                                          Events                                                -->
<!---------------------------------------------------------------------------------------------------->

<a name="eventLog" ></a>
<div class="container">
	
	<div class="row">
		<div class="col-lg-8 col-md-10 mx-auto">
			
			<h2 class="post-title float-left">Event Log</h2>
			
			<!-- Button to expose hidden table -->
			<a class="btn btn-primary float-right"  data-toggle="collapse" href="#collapseEventList"
			   role="button" aria-expanded="false" aria-controls="collapseExample">
	            SHOW
	        </a>
			
		</div>
	</div>

	<!-- Collapsed / Hidden table of cafes -->
	<div class="collapse" id="collapseEventList">
		<div class="row">
			<div class="col-lg-8 col-md-10 mx-auto my-5">
				
				<!-- Use a button group -->
				<div class="btn-group float-right" role="group">
				
					<!-- Change selection -->
					{% if days == "all" %}
						<a class="btn btn-sm btn-primary disabled" href="{{ url_for('admin_page', days='all') }}">
							All
						</a>
					{% else %}
						<a class="btn btn-sm btn-primary" href="{{ url_for('admin_page', days='all') }}">
							All
						</a>
					{% endif %}
					
					{% if days == 28 %}
						<a class="btn btn-sm btn-primary disabled" href="{{ url_for('admin_page', days=28 ) }}">
							4 Weeks
						</a>
					{% else %}
						<a class="btn btn-sm btn-primary" href="{{ url_for('admin_page', days=28 ) }}">
							4 Weeks
						</a>
					{% endif %}
					
					{% if days == 7 %}
						<a class="btn btn-sm btn-primary disabled" href="{{ url_for('admin_page', days=7 ) }}">
							1 Week
						</a>
					{% else %}
						<a class="btn btn-sm btn-primary" href="{{ url_for('admin_page', days=7 ) }}">
							1 Week
						</a>
					{% endif %}
					
					{% if days == 1 %}
						<a class="btn btn-sm btn-primary disabled" href="{{ url_for('admin_page', days=1) }}">
							24 hr
						</a>
					{% else %}
						<a class="btn btn-sm btn-primary" href="{{ url_for('admin_page', days=1) }}">
							24 hr
						</a>
					{% endif %}
				
					<!-- Delete Events (Super Admin only) -->
					{% if current_user.id == 1 %}
						<button class="btn btn-sm btn-danger" data-toggle="modal" data-target="#deleteEventsModal">
	                        Delete
						</button>
					{% endif %}
					
				</div> <!-- End button group -->
			</div> <!-- End column -->
		</div> <!-- End row -->
	
		<!-- Summary count -->
		<div class="row my-2">
			<div class="col-lg-8 col-md-10 mx-auto">
				<h4>{{ events|count }} events in {{ days }} days</h4>
			</div>
		</div>
		
		
		<div class="row">
			<div class="col-lg-8 col-md-10 mx-auto">
	
				{% if mobile %}
					<table id="eventTable" class="table table-striped table-bordered table-sm table-condensed">
				{% else %}
					<table id="eventTable" class="table table-striped table-bordered table-sm table-condensed" style="width: 730px">
				{% endif %}
				
					<!-- Header -->
					<thead>
						<tr>
							<th scope="col">ID</th>
							<th scope="col">Name</th>
							<th scope="col">Date</th>
							<th scope="col">Type</th>
							<th scope="col">Event</th>
						</tr>
					</thead>
					
					<tbody>
						{% for event in events|reverse: %}
						
							{% if flag_event(event.type) %}
								<tr class="table-danger">
							{% elif good_event(event.type) %}
								<tr class="table-success">
							{% else %}
								<tr>
							{% endif %}
						
							<td scope="row" class="small">{{ event.id }}
							<a href="{{ url_for('delete_event', event_id=event.id) }}">✘ </a></td>
							<td class="small">{{ get_user_name(event.email) }}</td>
							<td class="small">{{ readable_date(event.date) }}</td>
							<td class="small">{{ event.type }}</td>
							<td class="small">{{ event.details }}</td>
						</tr>
						
						{% endfor %}
					</tbody>
			
				</table>
			
				{% if not events: %}
					<h4>No events over the last {{ days }} days</h4>
				{% endif %}
			
			</div>
		</div>
	</div>
	
	<!-- Separator before next section -->
	<div class="row mb-3">
		<div class="col-lg-8 col-md-10 mx-auto">
			<hr>
		</div>
	</div>
	
</div>


<script>

	{% if anchor %}
		// Jump to anchor
        window.location = (""+window.location).replace(/#[A-Za-z0-9_]*$/,'')+"#{{anchor}}"
	{% endif %}
	
</script>


<!---------------------------------------------------------------------------------------------------->
<!--                               Activate jQuery on the Tables                                    -->
<!---------------------------------------------------------------------------------------------------->

<script>
	
	$(document).ready( function () {
		$('#userTable').DataTable();
		$('#eventTable').DataTable()
	} );
	
</script>



<!---------------------------------------------------------------------------------------------------->
<!--                              Modal form for deleting events                                    -->
<!---------------------------------------------------------------------------------------------------->

<div class="modal fade" id="deleteEventsModal" tabindex="-1" role="dialog" aria-labelledby="deleteEventsModal"
     aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLabel">Delete Events</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				Delete all events for {{ days }} days?
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
				<a href="{{ url_for('delete_events', days=days, user_id='admin') }}" type="button" class="btn btn-danger">
					DELETE
				</a>
			</div>
		</div>
	</div>
</div>


{% endblock %}



{% block scripts %}
{% endblock %}