{% extends "base.html" %}

<!---------------------------------------------------------------------------------------------------->
<!--                                 Bootstrap WTForm Support                                       -->
<!---------------------------------------------------------------------------------------------------->

{% import "bootstrap/wtf.html" as wtf %}


<!---------------------------------------------------------------------------------------------------->
<!--                                         Google Map JS                                          -->
<!---------------------------------------------------------------------------------------------------->

<!-- Pulling external JS file -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>


{% block content %}


<!---------------------------------------------------------------------------------------------------->
<!--                                       Page Header                                              -->
<!---------------------------------------------------------------------------------------------------->

{% if cafe.image_name: %}

	<!-- Cafe specific photo -->
	<header class="masthead"
	        style="background-image: url( {{cafe.image_name}} )">

{% else %}

	<!-- Generic photo -->
	<header  class="masthead"
	         style="background-image: url({{ url_for('static', filename='img/cafe-bg.jpg') }})">

{% endif %}

	<div class="overlay"></div>
	<div class="container">
		<div class="row">
			<div class="col-lg-8 col-md-10 mx-auto">
				<div class="page-heading">
					
					{% if cafe: %}
						<h1>Edit Cafe Details</h1>
					{% else: %}
						<h1>Add a new cafe</h1>
					{% endif %}
					
					<span class="subheading">Found a great cafe stop, let everyone else know...</span>
				</div>
			</div>
		</div>
	</div>
</header>


<!---------------------------------------------------------------------------------------------------->
<!--                                 Show flash messages                                            -->
<!---------------------------------------------------------------------------------------------------->

{% with messages = get_flashed_messages() %}
	{% if messages %}
		{% for message in messages %}
			<div class="alert alert-warning text-center">
				{{ message }}
			</div>
		{% endfor %}
	{% endif %}
{% endwith %}


<!---------------------------------------------------------------------------------------------------->
<!--             JavaScript for Google Map allowing user to locate a place on a map                 -->
<!---------------------------------------------------------------------------------------------------->

{% if GOOGLE_MAPS_API_KEY %}
	
	<script>
		
		(g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
		    key: "{{ GOOGLE_MAPS_API_KEY }}",
		    v: "weekly",
		    // Use the 'v' parameter to indicate the version to use (weekly, beta, alpha, etc.).
		    // Add other bootstrap parameters as needed, using camel case.
	    });
			
		let map;
		
		async function initMap() {
	       
	        // Request needed libraries.
	        const { Map, InfoWindow } = await google.maps.importLibrary("maps");
	        const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker",);
	        
	        const map = new Map(
	            document.getElementById("map"), {
	                center: {{ ELSR_HOME | tojson }},
	                restriction: {
	                    latLngBounds: {{ MAP_BOUNDS | tojson }},
	                    strictBounds: false,
	                },
	                zoom: 10,
	                center: {{ ELSR_HOME | tojson }},
	            }
	        );
	  
	        // Create the initial InfoWindow.
	        let infoWindow = new InfoWindow({
	            content: "Locate the cafe on the map and click to transfer the coordinates to the form below.",
	            position: {{ ELSR_HOME | tojson }},
	        });
	
	        infoWindow.open(map);
	  
	        // Configure the click listener.
	        map.addListener("click", (mapsMouseEvent) => {
	            
	            // Close the current InfoWindow.
	            infoWindow.close();
	            
	            // Populate the form
	            document.getElementById("lat").value = mapsMouseEvent.latLng.lat();
	            document.getElementById("lon").value = mapsMouseEvent.latLng.lng();
	            
	            // Create a new InfoWindow.
	            infoWindow = new google.maps.InfoWindow({
	                position: mapsMouseEvent.latLng,
	            });
	        
	            infoWindow.setContent(
	                "Form has been updated",
	            );
	            
	            infoWindow.open(map);
	  
	        });
	        
		}
		
		initMap();
	
		$(document).ready( function () {
			
			if ( document.getElementById("lat").value == "" ) {
	            document.getElementById("lat").value = "Click on map above to populate";
	            document.getElementById("lon").value = "Click on map above to populate"; }
	        
		})
	
	</script>
	
{% endif %}


<div class="container">
	<div class="row">
		<div class="col-lg-8 col-md-10 mx-auto">
	
			<h2>Locate the cafe on the map</h2>
			
			<!---------------------------------------------------------------------------------------------------->
			<!--                                Native Google Maps HTML                                         -->
			<!---------------------------------------------------------------------------------------------------->
			<div id="map" style="height: 500px"></div>
			
			<!-- Break before next section -->
			<hr>
	
		</div>
	</div>
</div>


<!---------------------------------------------------------------------------------------------------->
<!--                                       Cafe Edit form                                           -->
<!---------------------------------------------------------------------------------------------------->

<div class="container">
	<div class="row">
		<div class="col-lg-8 col-md-10 mx-auto">
			
			<h2 class="mb-3">Edit the cafe details</h2>
			<h3 class="mb-3">NB The cafe must be within 100 km of Cambridge.</h3>
			
			<!-- Load ckeditor -->
			{{ ckeditor.load() }}
			
			<!-- This is where the form will go -->
			{{ wtf.quick_form(form, novalidate=True, button_map={"submit": "primary"}) }}
			
			<!--  Configure the ckeditor to tell it which field in WTForm will need to be a CKEditor. -->
			{{ ckeditor.config(name='detail') }}
			
		</div>
	</div>
</div>


{% endblock %}


{% block scripts %}

{% endblock %}

