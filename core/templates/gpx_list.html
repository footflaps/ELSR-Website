{% extends "base.html" %}


{% block content %}


<!---------------------------------------------------------------------------------------------------->
<!--                                       Page Header                                              -->
<!---------------------------------------------------------------------------------------------------->

<header class="masthead" style="background-image: url({{ url_for('static', filename='img/gpx-bg.jpg')}})">
	<div class="overlay"></div>
	<div class="container">
		<div class="row">
			<div class="col-lg-8 col-md-10 mx-auto">
				<div class="page-heading">
					<h1>The GPX Files</h1>
					<span class="subheading">It's like the 'X Files' only better...</span>
				</div>
			</div>
		</div>
	</div>
</header>


<!---------------------------------------------------------------------------------------------------->
<!--                                 Show flash messages                                            -->
<!---------------------------------------------------------------------------------------------------->

{% with messages = get_flashed_messages() %}
	{% if messages %}
		{% for message in messages %}
			<div class="alert alert-warning text-center">
				{{ message }}
			</div>
		{% endfor %}
	{% endif %}
{% endwith %}


<!---------------------------------------------------------------------------------------------------->
<!--                                       List GPX Routes                                          -->
<!---------------------------------------------------------------------------------------------------->

<!--
	Jinja variables have very limited scope, eg they don't last beyond loop iterations. So you can't just
	create 'hidden' in the loop below and use it at the end. The fix is to add it to the namespace variables.
-->
{% set ns = namespace(hidden="") %}

<div class="container">
	
	<!-- Link to route planning guide -->
	<div class="row">
		<div class="col-lg-8 col-md-10 col-sm-12 mx-auto">
			<h4 class="text-center">
				<a href="{{ url_for('plan') }}">
					<i class="fa-solid fa-triangle-exclamation fa-fade"></i>
					How to choose a suitable route
					<i class="fa-solid fa-triangle-exclamation fa-fade"></i>
				</a>
			</h4>
		</div>
	</div>
	
	<!-- Table title and Add a route button -->
	<div class="row">
		<div class="col-lg-8 col-md-10 col-sm-12 mx-auto my-3">
			
			<h2 class="float-left pt-3" style="font-size: 30px;">Route List</h2>
   
			<!-- Check they have permission -->
			{% if current_user.is_authenticated and current_user.can_post_gpx() %}
				<a class="btn btn-primary float-right" href="{{ url_for('new_route') }}">
					<i class="fa-solid fa-circle-plus fa-beat fa-xl"></i>
					Add
				</a>
			{% endif %}
	
	    </div>
	</div>
	
	<!-- Table of all the routes -->
	<div class="row">
		<div class="col-lg-8 col-md-10 col-sm-12 mx-auto">
			
			<table id="gpxTable" class="display table table-striped table-bordered table-sm table-condensed" >
			
				<!-- Header -->
				<thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Name</th>
                        <th scope="col">Length (km)</th>
                        <th scope="col">Ascent (m)</th>
	                    {% if not mobile %}
	                        <th scope="col">Uploaded by</th>
	                    {% endif %}
                    </tr>
                </thead>
		
				<tbody>
					{% for gpx in gpxes: %}
					
						<!--
							Criteria for being to see a route is:
								1. It's public
								2. You're Admin (can see all)
								3. You are the author of the route
						-->
						
						<!-- Tortuous logic: current_user.admin() doesn't exist until they log in -->
						{% if not current_user.is_authenticated and not gpx.public(): %}
					
							<!-- Skip this row -->
					
						{% elif gpx.public() or current_user.admin() or gpx.email == current_user.email: %}
							
							{% if not gpx.public(): %}
								<!-- We have hidden rows for non public routes -->
								<tr class="table-warning">
								{% set ns.hidden = "NB Routes in yellow have not been made public yet by their owner and are only visible to Admins
				                                 and the owner. Only the owner can publish the route and make it public." %}
							{% else: %}
								<tr>
							{% endif %}
							
							<td scope="row">{{loop.index}}</td>
							<td scope="row"><a href="{{ url_for('gpx_details', gpx_id=gpx.id) }}">{{gpx.name}}</a></td>
							<td scope="row">{{gpx.length_km}}</td>
                            <td scope="row">{{gpx.ascent_m}}</td>
							{% if not mobile %}
								<td scope="row">{{get_user_name(gpx.email)}}</td>
							{% endif %}
					    </tr>
						{% endif %}
					{% endfor %}
				</tbody>
			
			</table>
			
			<!-- If we had hidden routes, we add a note here to explain what yellow means -->
			<p>{{ ns.hidden }}</p>
			
		</div>
	</div>
	
	<!-- Add a route button -->
	<div class="row">
		<div class="col-lg-8 col-md-10 col-sm-12 mx-auto">
			
			<!-- Check they have permission -->
			{% if current_user.is_authenticated and current_user.can_post_gpx() %}
				<a class="btn btn-primary float-right" href="{{ url_for('new_route') }}">
					<i class="fa-solid fa-circle-plus fa-beat fa-xl"></i>
					new route
				</a>
			{% else %}
				<a class="btn btn-primary disabled float-right">Log in to add a route</a>
			{% endif %}
			
		</div>
	</div>
	
	<!-- Separator before the footer -->
	<div class="row">
		<div class="col-lg-8 col-md-10 col-sm-12 mx-auto">
			<hr>
		</div>
	</div>
	
</div>


<!---------------------------------------------------------------------------------------------------->
<!--                               Activate jQuery on the Table                                     -->
<!---------------------------------------------------------------------------------------------------->

<script>
	
	$(document).ready( function () {
		$('#gpxTable').DataTable({
			pageLength: 20
		})
	} );
	
</script>



{% endblock %}
