{% extends "base.html" %}

<!---------------------------------------------------------------------------------------------------->
<!--                                 Bootstrap WTForm Support                                       -->
<!---------------------------------------------------------------------------------------------------->

{% import "bootstrap/wtf.html" as wtf %}


{% block content %}


<!---------------------------------------------------------------------------------------------------->
<!--                                       Page Header                                              -->
<!---------------------------------------------------------------------------------------------------->

<!-- Generic photo -->
<header  class="masthead"
         style="background-image: url({{ url_for('static', filename='img/poll-bg.jpg') }})">
	<div class="overlay"></div>
	<div class="container">
		<div class="row">
			<div class="col-lg-8 col-md-10 mx-auto">
				<div class="page-heading">
					<h1>ELSR Polling</h1>
					<span class="subheading">It's just like a General Election!</span>
				</div>
			</div>
		</div>
	</div>
</header>


<!---------------------------------------------------------------------------------------------------->
<!--                                 Show flash messages                                            -->
<!---------------------------------------------------------------------------------------------------->

{% with messages = get_flashed_messages() %}
	{% if messages %}
		{% for message in messages %}
			<div class="alert alert-warning text-center">
				{{ message }}
			</div>
		{% endfor %}
	{% endif %}
{% endwith %}


<!---------------------------------------------------------------------------------------------------->
<!--                                            Show poll                                           -->
<!---------------------------------------------------------------------------------------------------->

<div class="container">
	<div class="row">
		<div class="col-lg-8 col-md-10 mx-auto">

			<div class="card mt-3">
					<div class="card-body">
					
						<!-- Card title -->
						<h3 class="card-title">Poll: {{ poll.name }} </h3>
						<h4 class="card-title">
							Poll ends: {{ poll.termination_date[0:2] }}/{{ poll.termination_date[2:4] }}/{{ poll.termination_date[4:8] }}, Poll is currently
							<strong style="color:red">{{ poll.status }}</strong>
						</h4>
						<h4 class="card-title">Created by:
						    <!-- User Gravatar -->
							<img src="{{ poll.email | gravatar }}"
							         width="40"
									 style="border-radius: 50%;"/>
							{{ get_user_name(poll.email) }}, on
                            {{ poll.created_date[0:2] }}/{{ poll.created_date[2:4] }}/{{ poll.created_date[4:8] }}
						</h4>
						<hr>
						
						<!-- Card body -->
						<h4 class="card-text">Details:</h4>
						{{ poll.details | safe }}
						<hr>
						
						<!-- Card body -->
						{% if current_user.is_authenticated: %}
							<h4 class="card-text">You have used <strong style="color:red">{{ num_votes }}</strong> out of
								<strong style="color:red">{{ poll.max_selections }}</strong> available votes.
							</h4>
						{% else %}
							<h4 class="card-text">Choose up to
								<strong style="color:red">{{ poll.max_selections }}</strong> options:
							</h4>
						{% endif %}
						
						<!-- Warn non logged-in users they need to log in -->
						{% if not current_user.is_authenticated: %}
							<strong style="color:red">Log in to be able to vote</strong>
						{% endif %}
						
						<!-- Iterate over options -->
						<a name="votes"></a>
						{% for option in poll.options_html %}
							
							<!-- Show voting option with button -->
							<div class="mt-5">
								
								<strong class="float-left">
									<i class="fa-regular fa-circle-dot fa-xl"></i> &nbsp; {{ option }}
								</strong>
								
								{% if poll.status == POLL_OPEN %}
								
									{% if current_user.is_authenticated: %}
									
										{% if is_in_list(current_user.email, poll.responses[option]) %}
											<!-- Has already chosen this one -->
											<a href="{{ url_for('remove_vote', poll_id=poll.id, option=loop.index) }}">
												<button class="btn btn-sm btn-primary float-right">UNVOTE</button>
											</a>
										{% elif num_votes < poll.max_selections %}
											<!-- Has votes left -->
											<a href="{{ url_for('add_vote', poll_id=poll.id, option=loop.index) }}">
												<button class="btn btn-sm btn-primary float-right">VOTE</button>
											</a>
										{% elif poll.max_selections == 1 %}
											<!-- Single option poll, so can easily move vote -->
											<a href="{{ url_for('swap_vote', poll_id=poll.id, option=loop.index) }}">
												<button class="btn btn-sm btn-primary float-right">VOTE</button>
											</a>
										{% else %}
											<!-- Too complex to work out where we take the vote from -->
											<button class="btn btn-sm btn-dark disabled float-right">VOTE</button>
										{% endif %}
									
									{% else %}
									
										<button class="btn btn-sm btn-dark disabled float-right">LOG IN</button>
									
									{% endif %}
								
								{% endif %}
								
								<br>
								
							</div>
						
							<!-- Show existing voters as row of Gravatars -->
							<div class="my-3">
								
								{% if current_user.is_authenticated: %}
									{% if is_in_list(current_user.email, poll.responses[option]) %}
										
										<!-- Show user as first icon -->
										<img src="{{ current_user.email | gravatar }}"
									         width="40"
											 style="border-radius: 50%;"/>
								
										<!-- Everyone else -->
										{% for voter in poll.responses[option] %}
											{% if voter != current_user.email %}
												<img src="{{ voter | gravatar }}"
											         width="40"
													 style="border-radius: 50%;"/>
											{% endif %}
										{% endfor %}
								
									{% else %}
								
										<!-- Logged in, but not voted -->
										{% for voter in poll.responses[option] %}
											<img src="{{ voter | gravatar }}"
									         width="40"
											 style="border-radius: 50%;"/>
										{% endfor %}
								
									{% endif %}
								
								{% else %}
								
									<!-- Not logged in -->
									{% for voter in poll.responses[option] %}
										<img src="{{ voter | gravatar }}"
								         width="40"
										 style="border-radius: 50%;"/>
									{% endfor %}
								
								{% endif %}
							</div>
						
						{% endfor %}
						
					</div>
				</div>
			
			<hr>
			
		</div>
	</div>
</div>


<!---------------------------------------------------------------------------------------------------->
<!--                                    Admin / Owner Control                                       -->
<!---------------------------------------------------------------------------------------------------->

{% if current_user.is_authenticated %}
	{% if current_user.admin() or current_user.email == poll.email %}
	
	<div class="container">
		<div class="row">
			<div class="col-lg-8 col-md-10 mx-auto">

				 <a data-toggle="modal" data-target="#DeletePollModal">
					<button type="button" class="btn btn-danger float-right">DELETE POLL</button>
				 </a>
			
			</div>
		</div>
	</div>

	<div class="container">
		<div class="row">
			<div class="col-lg-8 col-md-10 mx-auto">

				<hr>
			
			</div>
		</div>
	</div>


		<!---------------------------------------------------------------------------------------------------->
		<!--                         Modal form for confirming unbarring user                               -->
		<!---------------------------------------------------------------------------------------------------->
		
		<div class="modal fade" id="DeletePollModal" tabindex="-1" role="dialog"
		     aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="DeletePollModalLabel"><strong>Delete Poll</strong></h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<!--
							NB To get the two parameters use:
								1. gpx_id = request.args.get('gpx_id', None)
		                        2. confirm = request.form['confirm']
						-->
						<form action="{{ url_for('delete_poll', poll_id=poll.id) }}" method="post">
							
							<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
							
							<div class="form-group">
								<label class="col-form-label">
									Enter <strong>your password</strong> below.
								</label>
								<input type="password" class="form-control" name="password">
							</div>
							
							<div class="modal-footer">
								<button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
								<button type="submit" class="btn btn-danger">Delete</button>
							</div>
							
						</form>
					</div>
				</div>
			</div>
		</div>  <!-- End of modal form -->

	{% endif %}
{% endif %}




<!---------------------------------------------------------------------------------------------------->
<!--                                        Jump to anchor                                          -->
<!---------------------------------------------------------------------------------------------------->

<script>
	
	{% if anchor == 'votes' %}
		
        /* Jump to anchor */
        window.location = (""+window.location).replace(/#[A-Za-z0-9_]*$/,'')+"#{{anchor}}"
	
	{% endif %}
	
</script>



{% endblock %}


{% block scripts %}

{% endblock %}